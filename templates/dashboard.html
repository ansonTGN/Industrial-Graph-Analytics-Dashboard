{% extends "base.html" %}

{% block content %}
<nav class="navbar navbar-dark shadow-sm" style="background: linear-gradient(90deg, #1e293b 0%, #334155 100%); flex-shrink: 0; z-index: 1040;">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
            <i class="fa-solid fa-network-wired text-info"></i> 
            <div>
                <div class="lh-1 fw-bold font-monospace">NEO4J ANALYTICS</div>
                <div style="font-size: 0.65rem; opacity: 0.7; letter-spacing: 1px;">PETROCHEM SYSTEMS</div>
            </div>
        </a>
        
        <!-- BOTÓN MÓVIL PARA SIDEBAR -->
        <button class="btn btn-outline-light d-lg-none me-auto ms-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div class="d-none d-lg-flex align-items-center bg-black bg-opacity-25 px-3 py-1 rounded-pill border border-secondary border-opacity-25 ms-auto">
            <span class="d-flex align-items-center text-light small fw-bold font-monospace">
                <i class="fa-solid fa-circle text-success me-2" style="font-size: 0.5rem; box-shadow: 0 0 8px #2ecc71;"></i>
                {{ db_host | default(value="Conectado") }}
            </span>
        </div>
        <a href="/" class="btn btn-outline-danger btn-sm rounded-pill px-3 py-0 ms-3" style="line-height: 28px;">
            <i class="fa-solid fa-power-off me-2"></i>Salir
        </a>
    </div>
</nav>

<!-- ESTRUCTURA FLEXIBLE PRINCIPAL -->
<div class="container-fluid d-flex flex-column overflow-hidden" style="height: calc(100vh - 56px);">
    <div class="row h-100 flex-nowrap"> 
        
        <!-- SIDEBAR (Offcanvas responsive para móviles) -->
        <div class="offcanvas-lg offcanvas-start col-lg-3 h-100 p-0 bg-white border-end d-flex flex-column shadow-sm" 
             tabindex="-1" 
             id="sidebarOffcanvas" 
             aria-labelledby="sidebarLabel"
             style="z-index: 1045;">
            
            <div class="offcanvas-header bg-light border-bottom d-lg-none">
                <h5 class="offcanvas-title fw-bold text-secondary" id="sidebarLabel"><i class="fa-solid fa-sliders me-2"></i>Panel de Control</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarOffcanvas" aria-label="Close"></button>
            </div>

            <div class="p-3 bg-light border-bottom flex-shrink-0 d-none d-lg-block">
                <h6 class="mb-0 fw-bold text-uppercase text-secondary small"><i class="fa-solid fa-sliders me-2"></i>Panel de Control</h6>
            </div>
            
            <div class="flex-grow-1 overflow-auto p-3" style="background-color: #f8f9fa;">
                <form action="/query" method="post" id="queryForm">
                    <div class="mb-4 bg-white p-3 rounded shadow-sm border">
                        <label class="form-label fw-bold small text-dark d-flex justify-content-between">
                            OBJETO OBJETIVO 
                            <span class="badge bg-info text-dark" id="target-badge" style="display:none;">Seleccionado</span>
                        </label>
                        <select id="select-param" name="param" autocomplete="off" placeholder="Buscar ID o Nombre...">
                            {% if current_param %}
                                <option value="{{ current_param }}" selected>{{ current_param_label }}</option>
                            {% endif %}
                        </select>
                        <div class="form-text small mt-1 text-muted fst-italic">
                            <i class="fa-solid fa-circle-info me-1"></i>Selecciona un nodo del grafo o tabla para rellenar esto.
                        </div>
                    </div>

                    <label class="form-label fw-bold small text-dark mb-2 px-1">CONSULTAS DISPONIBLES</label>
                    <div class="accordion accordion-flush shadow-sm rounded border overflow-hidden" id="queriesAccordion">
                        {% for category, queries in categorized_queries %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <button class="accordion-button collapsed fw-bold py-2 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" style="font-size: 0.85rem; color: #34495e;">
                                    <i class="fa-solid fa-folder me-2 text-primary opacity-50"></i> {{ category }}
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary ms-auto rounded-pill" style="font-size: 0.65rem;">{{ queries | length }}</span>
                                </button>
                            </h2>
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#queriesAccordion">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush">
                                        {% for q in queries %}
                                        <label class="list-group-item list-group-item-action d-flex align-items-center gap-2 border-0 py-2 ps-4" style="font-size: 0.8rem; cursor: pointer;">
                                            <input class="form-check-input flex-shrink-0" type="radio" name="query_id" value="{{ q.id }}" {% if current_query == q.id %}checked{% endif %} required>
                                            <div class="w-100" title="{{ q.description }}">
                                                <i class="fa-solid {{ q.icon }} me-1 opacity-50" style="width: 15px;"></i> {{ q.title }}
                                            </div>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="d-grid mt-4 pb-4">
                        <button type="submit" class="btn btn-primary fw-bold shadow py-2"><i class="fa-solid fa-bolt me-2"></i> EJECUTAR</button>
                    </div>
                </form>
                {% if error %}
                <div class="alert alert-danger mt-3 small shadow-sm border-0">{{ error }}</div>
                {% endif %}
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="col-12 col-lg-9 h-100 p-0 flex-grow-1 d-flex flex-column position-relative">
            {% if results %}
            <!-- Header Resultados -->
            <div class="bg-white px-4 py-3 border-bottom d-flex justify-content-between align-items-center shadow-sm flex-shrink-0" style="z-index: 10;">
                <div class="overflow-hidden">
                    <h5 class="mb-0 fw-bold text-primary text-truncate">{{ results.query_title }}</h5>
                    <div class="text-muted text-truncate" style="font-size: 0.75rem;">
                        <i class="fa-regular fa-clock me-1"></i>{{ results.timestamp }} 
                        <span class="mx-2">|</span> 
                        <i class="fa-solid fa-table-list me-1"></i>{{ results.rows | length }} res.
                    </div>
                </div>
                <div class="btn-group ms-2">
                    <button class="btn btn-sm btn-outline-primary fw-bold d-none d-md-inline-block" onclick="downloadGraphPNG()"><i class="fa-solid fa-camera me-1"></i> Captura</button>
                    <button class="btn btn-sm btn-outline-primary fw-bold d-md-none" onclick="downloadGraphPNG()"><i class="fa-solid fa-camera"></i></button>
                    
                    <button class="btn btn-sm btn-outline-success fw-bold d-none d-md-inline-block" onclick="exportCSV()"><i class="fa-solid fa-file-csv me-1"></i> CSV</button>
                    <button class="btn btn-sm btn-outline-success fw-bold d-md-none" onclick="exportCSV()"><i class="fa-solid fa-file-csv"></i></button>
                </div>
            </div>

            <!-- Área de Contenido -->
            <div class="d-flex flex-column flex-grow-1 overflow-hidden">
                <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                    <div class="card-header bg-light border-bottom p-2 flex-shrink-0">
                        <ul class="nav nav-pills nav-fill gap-2" id="resultTabs" role="tablist">
                            <li class="nav-item"><button class="nav-link {% if results.is_graph %}active{% endif %} fw-bold small py-1" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph-pane"><i class="fa-solid fa-circle-nodes me-2"></i><span class="d-none d-sm-inline">Grafo</span></button></li>
                            <li class="nav-item"><button class="nav-link {% if not results.is_graph %}active{% endif %} fw-bold small py-1" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-pane"><i class="fa-solid fa-table me-2"></i><span class="d-none d-sm-inline">Datos</span></button></li>
                            <li class="nav-item"><button class="nav-link fw-bold small py-1" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-pane"><i class="fa-solid fa-chart-simple me-2"></i><span class="d-none d-sm-inline">Stats</span></button></li>
                        </ul>
                    </div>

                    <div class="card-body p-0 position-relative flex-grow-1 overflow-hidden" style="background: #fcfcfc;">
                        <div class="tab-content h-100 w-100">
                            <!-- PANE GRAFO -->
                            <div class="tab-pane fade {% if results.is_graph %}show active{% endif %} h-100 w-100 position-relative" id="graph-pane">
                                <div id="network-container"></div>
                                <div class="position-absolute bottom-0 start-0 m-3 btn-group-vertical shadow-sm" style="z-index: 10;">
                                    <button class="btn btn-light border btn-sm" onclick="network.moveTo({scale: 1.5})"><i class="fa-solid fa-plus"></i></button>
                                    <button class="btn btn-light border btn-sm" onclick="network.fit()"><i class="fa-solid fa-compress"></i></button>
                                    <button class="btn btn-light border btn-sm" onclick="network.moveTo({scale: 0.5})"><i class="fa-solid fa-minus"></i></button>
                                </div>
                                <div class="position-absolute bottom-0 end-0 m-3 p-2 bg-white bg-opacity-90 rounded shadow-sm border small d-none d-sm-block" style="pointer-events: none; z-index: 10;">
                                    <span class="badge rounded-pill text-bg-light border text-dark me-1"><i class="fa-solid fa-circle text-warning"></i> Material</span>
                                    <span class="badge rounded-pill text-bg-light border text-dark me-1"><i class="fa-solid fa-circle text-primary"></i> Equipo</span>
                                    <span class="badge rounded-pill text-bg-light border text-dark"><i class="fa-solid fa-circle text-success"></i> Ubic.</span>
                                </div>
                            </div>
                            
                            <!-- PANE TABLA (MODIFICADO PARA SCROLL COMPLETO) -->
                            <div class="tab-pane fade {% if not results.is_graph %}show active{% endif %} h-100 p-0" id="table-pane" style="overflow: hidden;">
                                <div class="table-responsive h-100 w-100">
                                    <table class="table table-hover table-striped table-sm mb-0 align-middle small table-bordered">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th class="text-center bg-secondary text-nowrap" style="width: 40px;">#</th>
                                                {% for col in results.columns %}
                                                <!-- text-nowrap en header fuerza el ancho -->
                                                <th class="text-uppercase text-nowrap px-3">{{ col }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in results.rows %}
                                            <tr>
                                                <td class="text-center text-muted">{{ loop.index }}</td>
                                                {% for col in results.columns %}
                                                <!-- text-nowrap en celda asegura que la tabla crezca horizontalmente -->
                                                <td class="text-nowrap px-2">
                                                    {% if "ID" in col or "EQUIPO" == col or "MATERIAL" == col or "TAG" in col or "CODIGO" in col %}
                                                        {% if row[col] != "-" and "Lista" not in row[col] %}
                                                        <div class="d-flex justify-content-between align-items-center hover-target p-1 rounded transition">
                                                            <span class="fw-bold font-monospace text-dark">{{ row[col] }}</span>
                                                            <button class="btn btn-link btn-sm p-0 ms-2 text-decoration-none" onclick="updateSearchParam('{{ row[col] }}', '{{ row[col] }} ({{ col }})')" title="Usar como objetivo"><i class="fa-solid fa-crosshairs text-primary"></i></button>
                                                        </div>
                                                        {% else %}
                                                            {{ row[col] }}
                                                        {% endif %}
                                                    {% else %}
                                                        {{ row[col] }}
                                                    {% endif %}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- PANE CHART -->
                            <div class="tab-pane fade h-100 w-100 p-2 p-md-4 overflow-hidden" id="chart-pane">
                                <div class="d-flex flex-column h-100">
                                    <h6 class="text-center text-secondary text-uppercase fw-bold mb-3" id="chart-title">Análisis de Datos</h6>
                                    <div style="flex-grow: 1; position: relative; width: 100%;">
                                        <canvas id="mainChart"></canvas>
                                    </div>
                                    <p class="text-center text-muted small mt-2" id="chart-msg"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="h-100 d-flex flex-column justify-content-center align-items-center text-muted opacity-50 bg-light p-4 text-center">
                <div class="bg-white p-4 p-md-5 rounded-circle shadow-sm mb-4">
                    <i class="fa-solid fa-magnifying-glass-chart fa-3x fa-md-4x text-primary opacity-50"></i>
                </div>
                <h3 class="fw-bold text-dark fs-4">Esperando Consulta</h3>
                <p class="small">Seleccione una consulta o use el <br><b>Asistente IA</b>.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- CHAT MODAL -->
<button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
        style="position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; z-index: 1050;"
        data-bs-toggle="modal" data-bs-target="#aiModal">
    <i class="fa-solid fa-robot fa-xl"></i>
</button>

<div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg modal-fullscreen-sm-down">
        <div class="modal-content border-0 shadow-lg" style="height: 80vh;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold" id="aiModalLabel"><i class="fa-solid fa-brain me-2 text-info"></i>Asistente Industrial IA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light d-flex flex-column p-0">
                <div id="apiKeyConfig" class="p-4 bg-white border-bottom">
                    <label class="form-label fw-bold text-secondary small">TU CLAVE API DE OPENAI</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-key"></i></span>
                        <input type="password" id="openaiKeyInput" class="form-control" placeholder="sk-...">
                        <button class="btn btn-outline-primary" onclick="saveKey()">Guardar</button>
                    </div>
                    <div class="form-text small">La clave se guarda solo en tu navegador para realizar las consultas.</div>
                </div>
                <div id="chatArea" class="flex-grow-1 overflow-auto p-3" style="display: none;">
                    <div class="d-flex align-items-start mb-3">
                        <div class="bg-primary text-white rounded p-3 shadow-sm" style="max-width: 80%;">
                            Hola, soy tu asistente de base de datos. Tengo acceso a las {{ categorized_queries | length }} categorías de herramientas. ¿Qué necesitas saber sobre la planta?
                        </div>
                    </div>
                </div>
                <div id="inputArea" class="p-3 bg-white border-top" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="userPrompt" class="form-control" placeholder="Ej: ¿Cuáles son los equipos críticos?" onkeypress="handleEnter(event)">
                        <button class="btn btn-primary" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end shadow" tabindex="-1" id="nodeOffcanvas" data-bs-backdrop="false">
    <div class="offcanvas-header bg-primary text-white">
        <h5 id="offcanvasRightLabel" class="fw-bold"><i class="fa-solid fa-circle-info me-2"></i>Detalle del Nodo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="text-center mb-4">
            <div class="display-6 mb-2 text-primary"><i class="fa-solid fa-cube"></i></div>
            <h5 id="canvasNodeLabel" class="fw-bold text-break"></h5>
            <span id="canvasNodeType" class="badge bg-secondary fs-6"></span>
        </div>
        <div class="card bg-light border-0 mb-4">
            <div class="card-body">
                <label class="small text-muted fw-bold text-uppercase">Identificador Único</label>
                <div class="d-flex align-items-center gap-2">
                    <code id="canvasNodeId" class="fs-5 fw-bold text-dark text-break"></code>
                    <button class="btn btn-sm btn-outline-secondary" onclick="navigator.clipboard.writeText(document.getElementById('canvasNodeId').innerText)"><i class="fa-regular fa-copy"></i></button>
                </div>
            </div>
        </div>
        <div class="d-grid gap-2">
            <button class="btn btn-primary py-2 fw-bold" onclick="setFocusFromCanvas()"><i class="fa-solid fa-crosshairs me-2"></i> Usar como Objetivo</button>
            <button class="btn btn-outline-dark py-2" data-bs-dismiss="offcanvas">Cerrar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let tomSelectInstance;
    let network = null;
    let selectedNodeData = null; 
    let OPENAI_API_KEY = localStorage.getItem("openai_key");
    let availableTools = null;
    let chatHistory = [{role: "system", content: "Eres un experto en ingeniería de mantenimiento y análisis de grafos industrial. Tienes acceso a herramientas (funciones) que ejecutan consultas Cypher en Neo4j. Usa estas herramientas para responder preguntas basándote en datos reales. Si el usuario pregunta algo general, intenta buscar la herramienta más adecuada. Si una respuesta contiene una lista de equipos o materiales, preséntala de forma ordenada."}];

    document.addEventListener("DOMContentLoaded", function(){
        tomSelectInstance = new TomSelect("#select-param", {
            valueField: 'id', labelField: 'title', searchField: ['title', 'id'], 
            preload: 'focus', placeholder: 'Escribe para buscar...',
            load: function(query, callback) {
                fetch('/api/search?q=' + encodeURIComponent(query || '')).then(r=>r.json()).then(json=>callback(json)).catch(()=>callback());
            },
            render: { option: (item, escape) => `<div class="py-2 border-bottom"><span class="badge bg-secondary me-2">${escape(item.label)}</span><span class="fw-bold">${escape(item.title)}</span></div>` }
        });

        if(OPENAI_API_KEY) {
            document.getElementById('apiKeyConfig').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
            document.getElementById('inputArea').style.display = 'block';
            loadTools();
        }
        
        {% if current_query %}
            const activeRadio = document.querySelector('input[name="query_id"][value="{{ current_query }}"]');
            if(activeRadio) new bootstrap.Collapse(activeRadio.closest('.accordion-collapse'), { toggle: true });
        {% endif %}
    });

    function updateSearchParam(id, label) {
        if(tomSelectInstance) {
            tomSelectInstance.addOption({id: id, title: label, label: 'Selección Manual'});
            tomSelectInstance.setValue(id);
            const badge = document.getElementById('target-badge');
            badge.style.display = 'inline-block';
            setTimeout(() => badge.style.display = 'none', 2000);
            bootstrap.Offcanvas.getInstance(document.getElementById('nodeOffcanvas'))?.hide();
            const sidebarEl = document.getElementById('sidebarOffcanvas');
            const bsSidebar = bootstrap.Offcanvas.getInstance(sidebarEl);
            if(bsSidebar) bsSidebar.hide();
        }
    }
    function setFocusFromCanvas() { if (selectedNodeData) updateSearchParam(selectedNodeData.id, selectedNodeData.label); }

    function saveKey() {
        const key = document.getElementById('openaiKeyInput').value.trim();
        if(key.startsWith('sk-')) {
            localStorage.setItem("openai_key", key);
            OPENAI_API_KEY = key;
            document.getElementById('apiKeyConfig').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
            document.getElementById('inputArea').style.display = 'block';
            loadTools();
        } else {
            alert("La clave no parece válida (debe empezar por sk-)");
        }
    }

    function loadTools() {
        if(!availableTools) {
            fetch('/api/ai/tools').then(r => r.json()).then(data => { availableTools = data; });
        }
    }

    function handleEnter(e) { if(e.key === 'Enter') sendPrompt(); }

    async function sendPrompt() {
        const input = document.getElementById('userPrompt');
        const text = input.value.trim();
        if(!text) return;

        appendMessage('user', text);
        chatHistory.push({role: "user", content: text});
        input.value = '';
        showTyping();

        try {
            const response = await fetch("/api/openai_proxy", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${OPENAI_API_KEY}` },
                body: JSON.stringify({ model: "gpt-4o", messages: chatHistory, tools: availableTools, tool_choice: "auto" })
            });
            const data = await response.json();
            
            if(data.error) throw new Error(data.error.message || JSON.stringify(data.error));

            const choice = data.choices[0];
            const msg = choice.message;
            chatHistory.push(msg); 

            if(msg.tool_calls) {
                appendMessage('assistant', "⚙️ Consultando datos en tiempo real...", true);
                
                for(const toolCall of msg.tool_calls) {
                    const funcName = toolCall.function.name;
                    const args = JSON.parse(toolCall.function.arguments);
                    
                    const toolRes = await fetch('/api/execute', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query_id: funcName, param: args.param })
                    });
                    const toolData = await toolRes.json();
                    
                    chatHistory.push({
                        role: "tool",
                        tool_call_id: toolCall.id,
                        name: funcName,
                        content: JSON.stringify(toolData)
                    });
                }

                const finalRes = await fetch("/api/openai_proxy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${OPENAI_API_KEY}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: chatHistory })
                });
                const finalData = await finalRes.json();
                removeTyping();
                const finalMsg = finalData.choices[0].message.content;
                appendMessage('assistant', finalMsg);
                chatHistory.push({role: "assistant", content: finalMsg});

            } else {
                removeTyping();
                appendMessage('assistant', msg.content);
            }

        } catch (err) {
            removeTyping();
            appendMessage('assistant', "❌ Error: " + err.message);
        }
    }

    function appendMessage(role, text, isStatus=false) {
        const chatArea = document.getElementById('chatArea');
        const div = document.createElement('div');
        div.className = `d-flex align-items-start mb-3 ${role === 'user' ? 'justify-content-end' : ''}`;
        const contentClass = role === 'user' ? 'bg-secondary text-white' : (isStatus ? 'bg-warning text-dark' : 'bg-primary text-white');
        const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        div.innerHTML = `<div class="${contentClass} rounded p-3 shadow-sm" style="max-width: 80%; white-space: pre-wrap;">${formattedText}</div>`;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
        if(isStatus) return div; 
    }

    let typingIndicator = null;
    function showTyping() { typingIndicator = appendMessage('assistant', 'Pensando...', true); }
    function removeTyping() { if(typingIndicator) { typingIndicator.remove(); typingIndicator = null; } }

    {% if results %}
        const rows = {{ results.rows | json_encode() | safe }};
        const cols = {{ results.columns | json_encode() | safe }};
        const isGraphQuery = {{ results.is_graph | json_encode() }};
        const hasGraphData = cols.includes('A_ID') && cols.includes('B_ID');

        if (hasGraphData && isGraphQuery) initGraph(rows);
        else if (hasGraphData) document.getElementById('network-container').innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-muted flex-column"><i class="fa-solid fa-table fa-2x mb-2"></i><span>Vista tabular preferida.</span></div>';
        else document.getElementById('network-container').innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-muted flex-column"><i class="fa-solid fa-ban fa-2x mb-2"></i><span>Datos no representables en grafo.</span></div>';

        const numericKeywords = ['CANTIDAD', 'TOTAL', 'SCORE', 'VECES', 'PRECIO', 'STOCK', 'NUM', 'CONEXIONES', 'RIESGO', 'LONGITUD', 'DENSIDAD', 'PORCENTAJE', 'MEDIA', 'PROMEDIO', 'OBSOLETOS'];
        const numericCol = cols.find(c => numericKeywords.some(k => c.toUpperCase().includes(k)));
        const labelCol = cols.find(c => ['DESCRIPCION', 'NAME', 'NOMBRE', 'EQUIPO', 'MATERIAL', 'A_LABEL', 'PLANTA', 'TAG'].some(k => c.toUpperCase().includes(k))) || cols[0];

        if (numericCol && rows.length > 0) {
            document.getElementById('chart-title').innerText = `${numericCol} por ${labelCol}`;
            new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: rows.map(r => (r[labelCol]||'').substring(0,30)),
                    datasets: [{ label: numericCol, data: rows.map(r => parseFloat((r[numericCol]||'0').replace(/[^0-9.-]+/g,"")) || 0), backgroundColor: '#3498db', borderRadius: 4 }]
                }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });
        } else {
            document.getElementById('chart-msg').innerHTML = `<i class="fa-solid fa-circle-exclamation text-warning me-2"></i> No se encontraron datos graficables.`;
        }

        function initGraph(data) {
            const nodesMap = new Map(), edgesArr = [];
            data.forEach(row => {
                if(row.A_ID && !nodesMap.has(row.A_ID)) nodesMap.set(row.A_ID, {id:row.A_ID, label:row.A_LABEL?.substring(0,18)+'...', fullLabel:row.A_LABEL, group:row.A_TYPE});
                if(row.B_ID && !nodesMap.has(row.B_ID)) nodesMap.set(row.B_ID, {id:row.B_ID, label:row.B_LABEL?.substring(0,18)+'...', fullLabel:row.B_LABEL, group:row.B_TYPE});
                if(row.A_ID && row.B_ID) edgesArr.push({from:row.A_ID, to:row.B_ID, label:row.RELACION, arrows:'to', font:{align:'middle', size:9}});
            });
            network = new vis.Network(document.getElementById('network-container'), {nodes:new vis.DataSet(Array.from(nodesMap.values())), edges:new vis.DataSet(edgesArr)}, {
                nodes:{shape:'dot', font:{size:14, face:'Outfit'}}, edges:{smooth:true},
                groups: { Material:{color:{background:'#f1c40f',border:'#f39c12'}}, Equipo:{color:{background:'#3498db',border:'#2980b9'}}, UbicacionTecnica:{color:{background:'#2ecc71',border:'#27ae60'}} },
                physics:{stabilization:true, barnesHut:{gravitationalConstant:-4000}}
            });
            network.on("click", p => {
                if(p.nodes.length){ 
                    const n = nodesMap.get(p.nodes[0]); 
                    selectedNodeData = n; 
                    document.getElementById('canvasNodeLabel').innerText = n.fullLabel;
                    document.getElementById('canvasNodeId').innerText = n.id;
                    document.getElementById('canvasNodeType').innerText = n.group;
                    new bootstrap.Offcanvas(document.getElementById('nodeOffcanvas')).show();
                }
            });
        }
        function downloadGraphPNG() { network.fit({animation:false}); setTimeout(() => { let a = document.createElement('a'); a.download = 'grafo.png'; a.href = document.getElementById('network-container').getElementsByTagName('canvas')[0].toDataURL(); a.click(); }, 500); }
        function exportCSV() { let csv = cols.join(",") + "\n"; rows.forEach(r => csv += cols.map(c => `"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(",") + "\n"); let a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([csv], {type: 'text/csv'})); a.download = 'data.csv'; a.click(); }
    {% endif %}
</script>
{% endblock %}
